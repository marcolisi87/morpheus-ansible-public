---
# This playbook will install mysql Cluster on Oracle Linux 8.4 

- name: add mysql group
  ansible.builtin.group:
    name: mysql
    state: present

- name: add mysql user
  ansible.builtin.user:
    name: mysql
    comment: Mysql User
    group: mysql

# On all nodes
- name: Stop firewalld services 
  ansible.builtin.service:
    name: firewalld
    state: stopped
    enabled: no

# On all nodes. EL8-based systems such as RHEL8 and Oracle Linux 8 include a MySQL module that is enabled by default. Unless this module is disabled, it masks packages provided by MySQL repositories
- name: Disable default mysql module
  command: yum module disable mysql -y

# On data nodes 
- name: Download the rpm on data node if oracle linux 8
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-data-node-8.0.25-1.el8.x86_64.rpm

- name: Install the rpm
  command: rpm -Uvh mysql-cluster-community-data-node-8.0.25-1.el8.x86_64.rpm

# On sql nodes
- name: install libaio
  dnf: pkg=libaio, net-tools

- name: download client plugins
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-client-plugins-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-client-plugins-8.0.25-1.el8.x86_64.rpm

- name: Download common 
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-common-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-common-8.0.25-1.el8.x86_64.rpm

- name: Download client libs
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-libs-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-libs-8.0.25-1.el8.x86_64.rpm

- name: Download client
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-client-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-client-8.0.25-1.el8.x86_64.rpm

- name: Download the sql node rpm
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-server-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-server-8.0.25-1.el8.x86_64.rpm

# On Management Node
- name: Download and install management server rpm
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-management-server-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-management-server-8.0.25-1.el8.x86_64.rpm

- name: install libaio
  dnf: pkg=libaio, net-tools

- name: download client plugins
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-client-plugins-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-client-plugins-8.0.25-1.el8.x86_64.rpm

- name: Download common 
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-common-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-common-8.0.25-1.el8.x86_64.rpm

- name: Download client libs
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-libs-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-libs-8.0.25-1.el8.x86_64.rpm

- name: Download client
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-client-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-client-8.0.25-1.el8.x86_64.rpm

- name: Download ndbClient Library
  command: wget --continue -P /var/tmp https://dev.mysql.com/get/Downloads/MySQL-Cluster-8.0/mysql-cluster-community-ndbclient-8.0.25-1.el8.x86_64.rpm && rpm -Uvh /var/tmp/mysql-cluster-community-ndbclient-8.0.25-1.el8.x86_64.rpm

# start of ndbd on data node gave an connection error. Have disabled selinux on data and mgmt node and restarted them. Network cannot be DHCP as upon reboot it gets a new ip. Need to disable ipv6 on all machines